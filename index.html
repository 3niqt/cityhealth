<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Health Office</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            background-color: #e6f0ff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .form-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, getDocs, writeBatch, setDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let userId = null;

        window.firebase = {
            auth,
            db,
            appId
        };
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User signed in:", userId);
                await setupDataListener();
            } else {
                 if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        async function setupDataListener() {
            const draftedClientsRef = collection(db, `artifacts/${appId}/public/data/drafted_clients`);
            onSnapshot(draftedClientsRef, (snapshot) => {
                const clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDraftedClients(clients);
            });
        }

        window.saveClientDraft = async function() {
            const clientName = document.getElementById('client-name').value.trim();
            const medicinesListEl = document.getElementById('medicines-list');
            
            if (clientName === '') {
                return;
            }

            const medicines = [];
            const medicineEntries = medicinesListEl.querySelectorAll('.medicine-entry');
            medicineEntries.forEach(entry => {
                const name = entry.querySelector('span:first-child').textContent;
                const qty = entry.querySelector('span:last-child').textContent;
                medicines.push({ name, qty });
            });

            const newClientDraft = {
                name: clientName,
                medicines: medicines,
                center: window.currentCenter,
                userId: userId,
                createdAt: new Date()
            };

            const draftedClientsRef = collection(db, `artifacts/${appId}/public/data/drafted_clients`);
            try {
                await addDoc(draftedClientsRef, newClientDraft);
                clearClientForm();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }

        window.publishDrafts = async function() {
            const draftedClientsRef = collection(db, `artifacts/${appId}/public/data/drafted_clients`);
            const publishedClientsRef = collection(db, `artifacts/${appId}/public/data/published_clients`);
            const q = query(draftedClientsRef);
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                return;
            }

            const batch = writeBatch(db);
            const promises = [];

            querySnapshot.forEach(doc => {
                const clientData = doc.data();
                const newPublishedClient = {
                    ...clientData,
                    status: 'Not Claimed',
                    publishDate: new Date().toLocaleString(),
                    originalDraftId: doc.id
                };
                
                const newDocRef = doc(publishedClientsRef);
                batch.set(newDocRef, newPublishedClient);
                batch.delete(doc.ref);
            });

            try {
                await batch.commit();
                window.location.href = 'medicine_claim_admin.html';
            } catch (error) {
                console.error("Error publishing drafts: ", error);
            }
        }
        
        function renderDraftedClients(clients) {
            const draftedClientsListEl = document.getElementById('drafted-clients-list');
            draftedClientsListEl.innerHTML = '';
            
            if (clients.length === 0) {
                draftedClientsListEl.innerHTML = '<p>No drafted clients yet.</p>';
            } else {
                clients.forEach(client => {
                    const newDraftItem = document.createElement('div');
                    newDraftItem.className = 'p-4 bg-gray-100 rounded-lg mb-2 shadow-sm';
                    let medicinesHtml = client.medicines.length > 0 ? `<ul class="list-disc list-inside mt-2">` : `<p class="mt-2 text-gray-500">No medicines added</p>`;
                    client.medicines.forEach(med => {
                        medicinesHtml += `<li class="text-xs">${med.name} (Qty: ${med.qty})</li>`;
                    });
                    if (client.medicines.length > 0) {
                        medicinesHtml += `</ul>`;
                    }
                    newDraftItem.innerHTML = `
                        <span class="font-bold text-sm text-gray-800">${client.name}</span>
                        <p class="text-xs text-gray-600">Center: ${client.center}</p>
                        ${medicinesHtml}
                    `;
                    draftedClientsListEl.appendChild(newDraftItem);
                });
            }
        }
    </script>
</head>
<body class="bg-[#e6f0ff]">
    <!-- Main content container -->
    <div class="container w-full max-w-7xl">
        <!-- Header -->
        <header class="w-full bg-yellow-300 p-4 rounded-xl shadow-md flex items-center justify-between mb-8">
            <div class="flex items-center space-x-4">
                <img src="https://placehold.co/60x60/81C784/FFFFFF?text=Logo" alt="City Health Office Logo" class="h-10 w-10 md:h-12 md:w-12 rounded-full">
                <div class="flex flex-col">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">CITY HEALTH OFFICE</h1>
                    <p class="text-xs md:text-sm text-gray-500">Admin Dashboard --- Appointments</p>
                </div>
            </div>
            <button class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600" onclick="goToAdminPage()">
                <span class="font-bold">Go to Medicine Claim Admin</span>
            </button>
        </header>

        <!-- Appointments View -->
        <div id="appointments-view" class="w-full flex flex-col items-center">
            <!-- Search bar and clear button -->
            <div class="w-full flex justify-end items-center mb-8">
                <div class="relative w-full max-w-xs">
                    <input type="text" id="search-input" placeholder="Search Center..." class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="filterCenters()">
                </div>
                <button id="clear-button" class="ml-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:outline-none" onclick="clearSearch()">
                    CLEAR
                </button>
            </div>

            <!-- Button grid -->
            <div id="button-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 w-full">
                <!-- Buttons with click handlers -->
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('ALABANG')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">ALABANG</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('AYALA ALABANG')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">AYALA ALABANG</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('BAGONG SILANG')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">BAGONG SILANG</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('BAYANAN ANNEX')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">BAYANAN ANNEX</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('BAYANAN MAIN')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">BAYANAN MAIN</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('BULI')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">BULI</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('CITY HEALTH OFFICE')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">CITY HEALTH OFFICE</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('CUPANG')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">CUPANG</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('LAGUERTA')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">LAGUERTA</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('LAKEVIEW')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">LAKEVIEW</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('POBLACION')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">POBLACION</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('PUTATAN')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">PUTATAN</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('PUTATAN ANNEX')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">PUTATAN ANNEX</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('SITIO STO. NINO')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">SITIO STO. NINO</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('SOUTHVILLE')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">SOUTHVILLE</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('SUCAT')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">SUCAT</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('TUNASAN')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">TUNASAN</span>
                </button>
                <button class="bg-white p-4 md:p-6 rounded-xl border border-green-500 shadow-sm hover:shadow-lg transition-all transform hover:scale-105" onclick="showForm('VICTORIA')">
                    <span class="font-semibold text-sm md:text-base text-gray-700">VICTORIA</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Pop-up form modal -->
    <div id="form-modal" class="form-modal">
        <div class="form-content">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Add Client and Medicines</h2>
            <div class="mb-4">
                <label for="client-name" class="block text-gray-700 font-semibold mb-1">Client name</label>
                <input type="text" id="client-name" placeholder="Client name" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="mb-4">
                <label for="medicines-name" class="block text-gray-700 font-semibold mb-1">Medicines name</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="medicines-name" placeholder="Medicines name" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="medicines-qty" placeholder="Qty" class="w-1/4 p-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="add-med-button" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600" onclick="addMedicine()">Add med</button>
                </div>
                <div id="medicines-list" class="text-xs text-gray-500 mt-2">
                    <span id="medicines-placeholder">No medicines added yet.</span>
                </div>
            </div>

            <div class="flex space-x-4 mb-4">
                <button id="save-button" class="flex-1 bg-blue-700 text-white py-2 rounded-lg font-semibold hover:bg-blue-800" onclick="saveClientDraft()">Save Client (to draft)</button>
                <button id="clear-button-modal" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600" onclick="clearClientForm()">Clear Draft</button>
            </div>

            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">Drafted Clients</h2>
            <div id="drafted-clients-list" class="text-sm text-gray-500 mb-4">
                <p>No drafted clients yet.</p>
            </div>
            <button class="w-full bg-blue-700 text-white py-3 rounded-lg font-bold hover:bg-blue-800" onclick="publishDrafts()">Publish All Drafts</button>
        </div>
    </div>

    <script>
        // Global variables
        window.currentCenter = '';

        // Get elements for search functionality
        const searchInput = document.getElementById('search-input');
        const centerButtons = document.querySelectorAll('#button-grid button');

        function showForm(centerName) {
            const formModal = document.getElementById('form-modal');
            formModal.style.display = 'flex';
            window.currentCenter = centerName; // Store the center name
        }

        document.getElementById('form-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                this.style.display = 'none';
            }
        });

        function filterCenters() {
            const searchText = searchInput.value.toLowerCase();
            centerButtons.forEach(button => {
                const buttonText = button.querySelector('span').textContent.toLowerCase();
                if (buttonText.includes(searchText)) {
                    button.style.display = 'block';
                } else {
                    button.style.display = 'none';
                }
            });
        }

        function clearSearch() {
            searchInput.value = '';
            filterCenters();
        }

        function addMedicine() {
            const medicineNameInput = document.getElementById('medicines-name');
            const medicineQtyInput = document.getElementById('medicines-qty');
            const medicineList = document.getElementById('medicines-list');
            const placeholder = document.getElementById('medicines-placeholder');

            const name = medicineNameInput.value.trim();
            const qty = medicineQtyInput.value.trim();

            if (name !== '' && qty !== '') {
                if (placeholder) {
                    placeholder.style.display = 'none';
                }

                const medicineEntry = document.createElement('div');
                medicineEntry.className = 'flex justify-between items-center text-gray-700 py-1 medicine-entry';
                medicineEntry.innerHTML = `
                    <span>${name}</span>
                    <span class="font-semibold">${qty}</span>
                `;
                medicineList.appendChild(medicineEntry);

                medicineNameInput.value = '';
                medicineQtyInput.value = '';
            }
        }

        window.clearClientForm = function() {
            document.getElementById('client-name').value = '';
            document.getElementById('medicines-list').innerHTML = `<span id="medicines-placeholder">No medicines added yet.</span>`;
        }

        function goToAdminPage() {
            window.location.href = 'medicine_claim_admin.html';
        }
    </script>
</body>
</html>
